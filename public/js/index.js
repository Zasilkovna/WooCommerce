(()=>{"use strict";const e=window.wp.blocks,t=window.wc.blocksCheckout,n=JSON.parse('{"$schema":"https://schemas.wp.org/trunk/block.json","apiVersion":3,"name":"packeta/packeta-widget","version":"0.1.0","title":"Packeta Widget","category":"woocommerce","parent":["woocommerce/checkout-shipping-methods-block"],"attributes":{"lock":{"type":"object","default":{"remove":true,"move":true}}},"icon":"cart","description":"Packeta Widget Block","textdomain":"packeta-widget","viewScript":"file:./index.js"}'),i=window.React,o=window.wp.blockEditor,c=({children:e,buttonLabel:t,logoSrc:n,logoAlt:o,info:c,onClick:a,loading:r,placeholderText:l})=>(0,i.createElement)("div",{className:"packetery-widget-button-wrapper"},r&&(0,i.createElement)("div",{className:"packeta-widget-loading"},l),!r&&(0,i.createElement)("div",{className:"form-row packeta-widget blocks"},(0,i.createElement)("div",{className:"packetery-widget-button-row packeta-widget-button"},(0,i.createElement)("img",{className:"packetery-widget-button-logo",src:n,alt:o}),(0,i.createElement)("a",{onClick:a,className:"button alt components-button wc-block-components-button wp-element-button contained"},t)),e,c&&(0,i.createElement)("p",{className:"packeta-widget-info"},c))),a=window.wc.wcSettings,r=window.wc.blocksComponents,l=window.wp.i18n;(0,e.registerBlockType)(n,{title:(0,l.__)("title","packeta"),description:(0,l.__)("description","packeta"),edit:()=>{const e=(0,o.useBlockProps)();return(0,i.createElement)("div",{...e},(0,i.createElement)(c,{buttonLabel:"Choose pickup point",logoSrc:"data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPCEtLSBHZW5lcmF0b3I6IEFkb2JlIElsbHVzdHJhdG9yIDI1LjEuMCwgU1ZHIEV4cG9ydCBQbHVnLUluIC4gU1ZHIFZlcnNpb246IDYuMDAgQnVpbGQgMCkgIC0tPgo8c3ZnIHZlcnNpb249IjEuMSIgaWQ9IlZyc3R2YV8xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4PSIwcHgiIHk9IjBweCIKCSB2aWV3Qm94PSIwIDAgMzcgNDAiIHN0eWxlPSJmaWxsOiNhN2FhYWQiIHhtbDpzcGFjZT0icHJlc2VydmUiPgo8c3R5bGUgdHlwZT0idGV4dC9jc3MiPgoJLnN0MHtmaWxsLXJ1bGU6ZXZlbm9kZDtjbGlwLXJ1bGU6ZXZlbm9kZDtmaWxsOiAjYTdhYWFkO30KPC9zdHlsZT4KPHBhdGggY2xhc3M9InN0MCIgZD0iTTE5LjQsMTYuMWwtMC45LDAuNGwtMC45LTAuNGwtMTMtNi41bDYuMi0yLjRsMTMuNCw2LjVMMTkuNCwxNi4xeiBNMzIuNSw5LjZsLTQuNywyLjNsLTEzLjUtNmw0LjItMS42CglMMzIuNSw5LjZ6Ii8+CjxwYXRoIGNsYXNzPSJzdDAiIGQ9Ik0xOSwwbDE3LjIsNi42bC0yLjQsMS45bC0xNS4yLTZMMy4yLDguNkwwLjgsNi42TDE4LDBMMTksMEwxOSwweiBNMzQuMSw5LjFsMi44LTEuMWwtMi4xLDE3LjZsLTAuNCwwLjgKCUwxOS40LDQwbC0wLjUtMy4xbDEzLjQtMTJMMzQuMSw5LjF6IE0yLjUsMjYuNWwtMC40LTAuOEwwLDguMWwyLjgsMS4xbDEuOSwxNS43bDEzLjQsMTJMMTcuNiw0MEwyLjUsMjYuNXoiLz4KPHBhdGggY2xhc3M9InN0MCIgZD0iTTI4LjIsMTIuNGw0LjMtMi43bC0xLjcsMTQuMkwxOC42LDM1bDAuNi0xN2w1LjQtMy4zTDI0LjMsMjNsMy4zLTIuM0wyOC4yLDEyLjR6Ii8+CjxwYXRoIGNsYXNzPSJzdDAiIGQ9Ik0xNy43LDE3LjlsMC42LDE3bC0xMi4yLTExTDQuNCw5LjhMMTcuNywxNy45eiIvPgo8L3N2Zz4K",logoAlt:"Packeta",info:"Pickup Point Name"}))}}),(0,t.registerCheckoutBlock)({metadata:n,component:({cart:e})=>{const{shippingRates:t,cartItemsWeight:n}=e,o=(0,a.getSetting)("packeta-widget_data"),{carrierConfig:l,translations:s,logo:u,widgetAutoOpen:d,adminAjaxUrl:p}=o,w=((e,t)=>{if(!e||0===e.length)return null;const{shipping_rates:n}=e[0];return n&&0!==n.length&&n.find((({rate_id:e,selected:n})=>{if(!n)return!1;const i=e.split(":").pop(),o=t[i];if(!o)return!1;const{is_pickup_points:c}=o;return o&&c}))||null})(t,l),[g,m]=(e=>{let[t,n]=(0,i.useState)(null),[o,c]=(0,i.useState)(!1);return[t,o]=((e,t,n,o,c)=>((0,i.useEffect)((()=>{const i=function(){let e=document.querySelector("#shipping-country input");return e||(e=document.querySelector("#billing-country input")),e?e.value:null}();null!==i&&(null===t||null===t.countryName?n((e=>({...e,countryName:i}))):t.countryName!==i&&(o||(c(!0),fetch(e,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"translate_country_name",countryName:i})}).then((e=>e.json())).then((e=>{null!==e&&n((t=>({...t,country:e})))})).catch((e=>{console.error("Error:",e)})).finally((()=>{c(!1)}))),n((e=>({...e,countryName:i})))))})),[t,o]))(e,t,n,o,c),(0,i.useEffect)((()=>{o||null!==t||(c(!0),fetch(e,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"get_settings"})}).then((e=>e.json())).then((e=>{const{isAgeVerificationRequired:t}=e;n((e=>({...e,isAgeVerificationRequired:t})))})).catch((e=>{console.error("Error:",e),n(!1)})).finally((()=>{c(!1)})))}),[t,e,o]),[t,o]})(p),[k,M]=((e,t,n,o)=>{const{carrierConfig:c,country:a,language:r,packeteryApiKey:l,appIdentity:s,nonce:u,saveSelectedPickupPointUrl:d,pickupPointAttrs:p}=t,[w,g]=(0,i.useState)(null);return[(0,i.useCallback)((()=>{const t=e.rate_id.split(":").pop();let i=+(o/1e3).toFixed(2),w=a;n&&n.country&&(w=n.country);let m={country:w,language:r,appIdentity:s,weight:i};c[t].carriers&&(m.carriers=c[t].carriers),c[t].vendors&&(m.vendors=c[t].vendors),n&&n.isAgeVerificationRequired&&(m.livePickupPoint=!0);let k={};Packeta.Widget.pick(l,(e=>{if(!e)return;g({pickupPoint:e}),function(e,t,n){for(let i in t){if(!t.hasOwnProperty(i))continue;const{name:o,widgetResultField:c,isWidgetResultField:a}=t[i];if(!1===a)continue;let r=n[c||i];k[e]=k[e]||{},k[e][o]=r}}(t,p,e);let n=k[t];n.packetery_rate_id=t,fetch(d,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","X-WP-Nonce":u},body:new URLSearchParams(n)}).then((e=>{if(!e.ok)throw new Error("HTTP error "+e.status)})).catch((e=>{console.error("Failed to save pickup point data:",e)}))}),m)}),[e,n]),w]})(w,o,g,n);(0,i.useEffect)((()=>{w&&g&&!M&&d&&k()}),[w,d,k]);const{choosePickupPoint:L,packeta:y}=s;return w?(0,i.createElement)(c,{onClick:k,buttonLabel:L,logoSrc:u,logoAlt:y,info:M&&M.pickupPoint&&M.pickupPoint.name,loading:m,placeholderText:s.placeholderText},(0,i.createElement)(r.ValidatedTextInput,{value:M&&M.pickupPoint&&M.pickupPoint.name,required:!0,errorMessage:function(e){return e&&e.pickupPoint?null:s.pickupPointNotChosen}(M)})):null}})})();