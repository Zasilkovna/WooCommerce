(()=>{"use strict";const e=window.wp.blocks,t=window.wc.blocksCheckout,i=JSON.parse('{"$schema":"https://schemas.wp.org/trunk/block.json","apiVersion":3,"name":"packeta/packeta-widget","version":"0.1.0","title":"Packeta Widget","category":"woocommerce","parent":["woocommerce/checkout-shipping-methods-block"],"attributes":{"lock":{"type":"object","default":{"remove":true,"move":true}}},"icon":"cart","description":"Packeta Widget Block","textdomain":"packeta-widget","viewScript":"file:./index.js"}'),o=window.React,n=window.wp.blockEditor,c=({children:e,buttonLabel:t,logoSrc:i,logoAlt:n,info:c,onClick:a,loading:r,placeholderText:s})=>(0,o.createElement)("div",{className:"packetery-widget-button-wrapper"},r&&(0,o.createElement)("div",{className:"packeta-widget-loading"},s),!r&&(0,o.createElement)("div",{className:"form-row packeta-widget blocks"},(0,o.createElement)("div",{className:"packetery-widget-button-row packeta-widget-button"},(0,o.createElement)("img",{className:"packetery-widget-button-logo",src:i,alt:n}),(0,o.createElement)("a",{onClick:a,className:"button alt components-button wc-block-components-button wp-element-button contained"},t)),e,c&&(0,o.createElement)("p",{className:"packeta-widget-info"},c))),a=window.wc.wcSettings,r=window.wc.blocksComponents,s=window.wp.i18n;(0,e.registerBlockType)(i,{title:(0,s.__)("title","packeta"),description:(0,s.__)("description","packeta"),edit:()=>{const e=(0,n.useBlockProps)();return(0,o.createElement)("div",{...e},(0,o.createElement)(c,{buttonLabel:"Choose pickup point",logoSrc:"data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPCEtLSBHZW5lcmF0b3I6IEFkb2JlIElsbHVzdHJhdG9yIDI1LjEuMCwgU1ZHIEV4cG9ydCBQbHVnLUluIC4gU1ZHIFZlcnNpb246IDYuMDAgQnVpbGQgMCkgIC0tPgo8c3ZnIHZlcnNpb249IjEuMSIgaWQ9IlZyc3R2YV8xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4PSIwcHgiIHk9IjBweCIKCSB2aWV3Qm94PSIwIDAgMzcgNDAiIHN0eWxlPSJmaWxsOiNhN2FhYWQiIHhtbDpzcGFjZT0icHJlc2VydmUiPgo8c3R5bGUgdHlwZT0idGV4dC9jc3MiPgoJLnN0MHtmaWxsLXJ1bGU6ZXZlbm9kZDtjbGlwLXJ1bGU6ZXZlbm9kZDtmaWxsOiAjYTdhYWFkO30KPC9zdHlsZT4KPHBhdGggY2xhc3M9InN0MCIgZD0iTTE5LjQsMTYuMWwtMC45LDAuNGwtMC45LTAuNGwtMTMtNi41bDYuMi0yLjRsMTMuNCw2LjVMMTkuNCwxNi4xeiBNMzIuNSw5LjZsLTQuNywyLjNsLTEzLjUtNmw0LjItMS42CglMMzIuNSw5LjZ6Ii8+CjxwYXRoIGNsYXNzPSJzdDAiIGQ9Ik0xOSwwbDE3LjIsNi42bC0yLjQsMS45bC0xNS4yLTZMMy4yLDguNkwwLjgsNi42TDE4LDBMMTksMEwxOSwweiBNMzQuMSw5LjFsMi44LTEuMWwtMi4xLDE3LjZsLTAuNCwwLjgKCUwxOS40LDQwbC0wLjUtMy4xbDEzLjQtMTJMMzQuMSw5LjF6IE0yLjUsMjYuNWwtMC40LTAuOEwwLDguMWwyLjgsMS4xbDEuOSwxNS43bDEzLjQsMTJMMTcuNiw0MEwyLjUsMjYuNXoiLz4KPHBhdGggY2xhc3M9InN0MCIgZD0iTTI4LjIsMTIuNGw0LjMtMi43bC0xLjcsMTQuMkwxOC42LDM1bDAuNi0xN2w1LjQtMy4zTDI0LjMsMjNsMy4zLTIuM0wyOC4yLDEyLjR6Ii8+CjxwYXRoIGNsYXNzPSJzdDAiIGQ9Ik0xNy43LDE3LjlsMC42LDE3bC0xMi4yLTExTDQuNCw5LjhMMTcuNywxNy45eiIvPgo8L3N2Zz4K",logoAlt:"Packeta",info:"Pickup Point Name"}))}}),(0,t.registerCheckoutBlock)({metadata:i,component:({cart:e})=>{const[t,i]=(0,o.useState)(null),{shippingRates:n,shippingAddress:s,cartItemsWeight:l}=e,u=(0,a.getSetting)("packeta-widget_data"),{carrierConfig:w,translations:d,logo:p,widgetAutoOpen:g,adminAjaxUrl:k}=u,M=((e,t)=>{if(!e||0===e.length)return null;const{shipping_rates:i}=e[0];return i&&0!==i.length&&i.find((({rate_id:e,selected:i})=>{if(!i)return!1;const o=e.split(":").pop(),n=t[o];if(!n)return!1;const{is_pickup_points:c}=n;return n&&c}))||null})(n,w),[L,m,b]=(e=>{let[t,i]=(0,o.useState)(null),[n,c]=(0,o.useState)(!1);return(0,o.useEffect)((()=>{n||null!==t||(c(!0),fetch(e,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"get_settings"})}).then((e=>e.json())).then((e=>{const{isAgeVerificationRequired:t}=e;i((e=>({...e,isAgeVerificationRequired:t})))})).catch((e=>{console.error("Error:",e),i(!1)})).finally((()=>{c(!1)})))}),[t,e,n]),[t,i,n]})(k);(0,o.useEffect)((()=>{if(!L)return;const e=s.country.toLowerCase();L.lastCountry?L.lastCountry!==e&&(t&&i(null),m({...L,lastCountry:e})):m({...L,lastCountry:e})}),[L,m,t,i,s]);const N=((e,t,i,n,c,a)=>{const{carrierConfig:r,language:s,packeteryApiKey:l,appIdentity:u,nonce:w,saveSelectedPickupPointUrl:d,pickupPointAttrs:p}=t;return(0,o.useCallback)((()=>{const t=e.rate_id.split(":").pop();let o=+(a/1e3).toFixed(2),g={language:s,appIdentity:u,weight:o};g.country=c.country.toLowerCase(),r[t].carriers&&(g.carriers=r[t].carriers),r[t].vendors&&(g.vendors=r[t].vendors),i&&i.isAgeVerificationRequired&&(g.livePickupPoint=!0);let k={};Packeta.Widget.pick(l,(e=>{if(!e)return;n({pickupPoint:e}),function(e,t,i){for(let o in t){if(!t.hasOwnProperty(o))continue;const{name:n,widgetResultField:c,isWidgetResultField:a}=t[o];if(!1===a)continue;let r=i[c||o];k[e]=k[e]||{},k[e][n]=r}}(t,p,e);let i=k[t];i.packetery_rate_id=t,fetch(d,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","X-WP-Nonce":w},body:new URLSearchParams(i)}).then((e=>{if(!e.ok)throw new Error("HTTP error "+e.status)})).catch((e=>{console.error("Failed to save pickup point data:",e)}))}),g)}),[e,i])})(M,u,L,i,s,l);(0,o.useEffect)((()=>{M&&L&&!t&&g&&N()}),[M,g,N]);const{choosePickupPoint:y,packeta:I}=d;return M?(0,o.createElement)(c,{onClick:N,buttonLabel:y,logoSrc:p,logoAlt:I,info:t&&t.pickupPoint&&t.pickupPoint.name,loading:b,placeholderText:d.placeholderText},(0,o.createElement)(r.ValidatedTextInput,{value:t&&t.pickupPoint?t.pickupPoint.name:"",required:!0,errorMessage:function(e){return e&&e.pickupPoint?null:d.pickupPointNotChosen}(t)})):null}})})();