(()=>{"use strict";const e=window.wp.blocks,t=window.wc.blocksCheckout,n=JSON.parse('{"$schema":"https://schemas.wp.org/trunk/block.json","apiVersion":3,"name":"packeta/packeta-widget","version":"0.1.0","title":"Packeta Widget","category":"woocommerce","parent":["woocommerce/checkout-shipping-methods-block"],"attributes":{"lock":{"type":"object","default":{"remove":true,"move":true}}},"icon":"cart","description":"Packeta Widget Block","textdomain":"packeta-widget","viewScript":"file:./index.js"}'),o=window.React,c=window.wp.blockEditor,i=({children:e,buttonLabel:t,logoSrc:n,logoAlt:c,info:i,onClick:a,loading:r,placeholderText:l})=>(0,o.createElement)("div",{className:"packetery-widget-button-wrapper"},r&&(0,o.createElement)("div",{className:"packeta-widget-loading"},l),!r&&(0,o.createElement)("div",{className:"form-row packeta-widget blocks"},(0,o.createElement)("div",{className:"packetery-widget-button-row packeta-widget-button"},(0,o.createElement)("img",{className:"packetery-widget-button-logo",src:n,alt:c}),(0,o.createElement)("a",{onClick:a,className:"button alt components-button wc-block-components-button wp-element-button contained"},t)),e,i&&(0,o.createElement)("p",{className:"packeta-widget-info"},i))),a=window.wc.wcSettings,r=window.wc.blocksComponents,l=window.wp.i18n;(0,e.registerBlockType)(n,{title:(0,l.__)("title","packeta"),description:(0,l.__)("description","packeta"),edit:()=>{const e=(0,c.useBlockProps)();return(0,o.createElement)("div",{...e},(0,o.createElement)(i,{buttonLabel:"Choose pickup point",logoSrc:"/wp-content/plugins/packeta/public/packeta-symbol.png",logoAlt:"Packeta",info:"Pickup Point Name"}))}}),(0,t.registerCheckoutBlock)({metadata:n,component:({cart:e})=>{const{shippingRates:t}=e,n=(0,a.getSetting)("packeta-widget_data"),{carrierConfig:c,translations:l,logo:s,widgetAutoOpen:p,adminAjaxUrl:u}=n,d=((e,t)=>{if(!e||0===e.length)return null;const{shipping_rates:n}=e[0];return n&&0!==n.length&&n.find((({rate_id:e,selected:n})=>{if(!n)return!1;const o=e.split(":").pop(),c=t[o];if(!c)return!1;const{is_pickup_points:i}=c;return c&&i}))||null})(t,c),[w,g]=(e=>{let[t,n]=(0,o.useState)(null),[c,i]=(0,o.useState)(!1);return[t,c]=((e,t,n,c,i)=>((0,o.useEffect)((()=>{const o=function(){const e=document.querySelector("#shipping-country input");return e?e.value:null}();null!==o&&(null===t||null===t.countryName?n((e=>({...e,countryName:o}))):t.countryName!==o&&(c||(i(!0),fetch(e,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"translate_country_name",countryName:o})}).then((e=>e.json())).then((e=>{null!==e&&n((t=>({...t,country:e})))})).catch((e=>{console.error("Error:",e)})).finally((()=>{i(!1)}))),n((e=>({...e,countryName:o})))))})),[t,c]))(e,t,n,c,i),(0,o.useEffect)((()=>{c||null!==t||(i(!0),fetch(e,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"get_settings"})}).then((e=>e.json())).then((e=>{const{weight:t,isAgeVerificationRequired:o}=e;n((e=>({...e,weight:t,isAgeVerificationRequired:o})))})).catch((e=>{console.error("Error:",e),n(!1)})).finally((()=>{i(!1)})))}),[t,e,c]),[t,c]})(u),[k,m]=((e,t,n)=>{const{carrierConfig:c,country:i,language:a,packeteryApiKey:r,appIdentity:l,nonce:s,saveSelectedPickupPointUrl:p,pickupPointAttrs:u}=t,[d,w]=(0,o.useState)(null);return[(0,o.useCallback)((()=>{const t=e.rate_id.split(":").pop();let o=0;n&&n.weight&&(o=n.weight);let d=i;n&&n.country&&(d=n.country);let g={country:d,language:a,appIdentity:l,weight:o};c[t].carriers&&(g.carriers=c[t].carriers),c[t].vendors&&(g.vendors=c[t].vendors),n&&n.isAgeVerificationRequired&&(g.livePickupPoint=!0);let k={};Packeta.Widget.pick(r,(e=>{if(!e)return;w({pickupPoint:e}),function(e,t,n){for(let o in t){if(!t.hasOwnProperty(o))continue;const{name:c,widgetResultField:i,isWidgetResultField:a}=t[o];if(!1===a)continue;let r=n[i||o];k[e]=k[e]||{},k[e][c]=r}}(t,u,e);let n=k[t];n.packetery_rate_id=t,fetch(p,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","X-WP-Nonce":s},body:new URLSearchParams(n)}).then((e=>{if(!e.ok)throw new Error("HTTP error "+e.status)})).catch((e=>{console.error("Failed to save pickup point data:",e)}))}),g)}),[e,n]),d]})(d,n,w);(0,o.useEffect)((()=>{d&&w&&!m&&p&&k()}),[d,p,k]);const{choosePickupPoint:h,packeta:f}=l;return d?(0,o.createElement)(i,{onClick:k,buttonLabel:h,logoSrc:s,logoAlt:f,info:m&&m.pickupPoint&&m.pickupPoint.name,loading:g,placeholderText:l.placeholderText},(0,o.createElement)(r.ValidatedTextInput,{value:m&&m.pickupPoint&&m.pickupPoint.name,required:!0,errorMessage:function(e){return e&&e.pickupPoint?null:l.pickupPointNotChosen}(m)})):null}})})();